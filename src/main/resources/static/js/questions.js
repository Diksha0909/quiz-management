const api='/api'; let quizId=null;
document.addEventListener('DOMContentLoaded',()=>{const p=new URLSearchParams(location.search); quizId=Number(p.get('quizId')); document.getElementById('btn-save-title').onclick=saveTitle; document.getElementById('btn-add-question').onclick=addQuestion; document.getElementById('q-type').onchange=changeType; changeType(); loadQuiz();});
function changeType(){const t=document.getElementById('q-type').value; document.getElementById('tf-row').style.display=(t==='TRUE_FALSE')?'flex':'none'; document.getElementById('st-row').style.display=(t==='SHORT_TEXT')?'flex':'none';}
async function loadQuiz(){const res=await fetch(api+'/admin/quizzes/'+quizId); const quiz=await res.json(); document.getElementById('quiz-title').value=quiz.title; const tb=document.getElementById('q-table'); tb.innerHTML='';
 quiz.questions.forEach(q=>{const tr=document.createElement('tr'); const correctCell = q.type==='MCQ' ? (q.choices||[]).map(c=>`${c.text}${c.correct?' ✅':''}`).join('<br/>') : (q.type==='TRUE_FALSE' ? (q.correctTrueFalse===true?'True':'False') : (q.correctShortText||''));
 tr.innerHTML=`<td>${q.id}</td><td>${q.text}</td><td>${q.type}</td><td>${correctCell}</td><td><button onclick="editQuestion(${q.id}, '${q.type}', '${String(q.correctTrueFalse)}', '${(q.correctShortText||'').replace(/'/g,"\'")}')">Edit</button> <button onclick='delQuestion(${q.id})'>Delete</button></td>`;
 if(q.type==='MCQ'){const tr2=document.createElement('tr'); tr2.innerHTML=`<td></td><td colspan='4'><b>Choices</b><ul>${(q.choices||[]).map(c=>`<li>#${c.id} — ${c.text} ${c.correct?'(correct)':''} <button onclick="editChoice(${c.id}, '${c.text.replace(/'/g,"\'")}', ${c.correct})">Edit</button> <button onclick='delChoice(${c.id})'>Delete</button></li>`).join('')}</ul>
 <div class='row'><input id='choice-text-${q.id}' placeholder='Choice text'><label><input type='checkbox' id='choice-correct-${q.id}'> Correct</label><button onclick='addChoice(${q.id})'>Add Choice</button></div></td>`; tb.appendChild(tr); tb.appendChild(tr2);} else { tb.appendChild(tr); } });}
async function saveTitle(){const title=document.getElementById('quiz-title').value.trim(); if(!title) return; await fetch(api+'/admin/quizzes/'+quizId,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({title})}); loadQuiz();}
async function addQuestion(){const type=document.getElementById('q-type').value; const text=document.getElementById('q-text').value.trim(); if(!text) return; const body={type,text}; if(type==='TRUE_FALSE') body.correctTrueFalse=document.getElementById('q-tf').value==='true'; if(type==='SHORT_TEXT') body.correctShortText=document.getElementById('q-st').value; await fetch(api+'/admin/quizzes/'+quizId+'/questions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); document.getElementById('q-text').value=''; loadQuiz();}
async function editQuestion(id, type, tf, st){const text=prompt('Question text:'); if(text===null) return; const ntype=prompt('Type (MCQ | TRUE_FALSE | SHORT_TEXT):', type); let body={text, type: ntype}; if(ntype==='TRUE_FALSE') body.correctTrueFalse = prompt('Correct (true/false):', tf)==='true'; if(ntype==='SHORT_TEXT') body.correctShortText = prompt('Correct text:', st||''); await fetch(api+'/admin/questions/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); loadQuiz();}
async function delQuestion(id){await fetch(api+'/admin/questions/'+id,{method:'DELETE'}); loadQuiz();}
async function addChoice(qid){const text=document.getElementById('choice-text-'+qid).value.trim(); if(!text) return; const correct=document.getElementById('choice-correct-'+qid).checked; await fetch(api+'/admin/questions/'+qid+'/choices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, correct})}); document.getElementById('choice-text-'+qid).value=''; document.getElementById('choice-correct-'+qid).checked=false; loadQuiz();}
async function editChoice(id, text, correct){const nt=prompt('Choice text:', text); if(nt===null) return; const nc=prompt('Is correct? (true/false):', String(correct))==='true'; await fetch(api+'/admin/choices/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({text: nt, correct: nc})}); loadQuiz();}
async function delChoice(id){await fetch(api+'/admin/choices/'+id,{method:'DELETE'}); loadQuiz();}
